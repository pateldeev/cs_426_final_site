<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!--What the tab displays-->
        <title>MusicAi Player</title>

        <!--All of the sources, libraries, and plugins used for the music player-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://unpkg.com/wavesurfer.js"></script>
        <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.regions.min.js"></script>
        <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.cursor.min.js"></script>
        <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script>
        <script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.microphone.min.js"></script>
        <script type="text/javascript" src="scripts/play_music.js"></script>

        <!--Attaching the css file-->
        <link rel="stylesheet" href="play_music.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
        <link rel="manifest" href="/favicon/site.webmanifest">
        <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg">       
        <link rel="stylesheet" href="play_music.css">
    </head>
    <body>

        <!--Order in which wavesurfer objects are placed-->
        <div id="waveform"></div>
        <div id="audio-spectrum"></div>
        <div id="wave-timeline"></div>
        <br>

        <!--Audio Controls-->
    <center>
        <input class = "button" type="button" id="btn-play" value="Play" />
        <input class = "button" type="button" id="btn-pause" value="Pause"/>
        <input class = "button" type="button" id="btn-stop" value="Stop"/>
        <input class = "button" type="button" id="btn-mute" value="Mute" disabled="disabled"/>
        <input class = "button" type="button" id="btn-unmute" value="Unmute" disabled="disabled"/>
    </center>

    <!--Volume Controls and Dropdown-->
    <center>
        <div class= "slidecontainer">
            Volume:<br/>
            <input id="volume" type="range" class= "slider" min="0" max="1" value="1" step="0.1">
        </div>

        <select id='dropdown'>
            <option value="0">Select</option>
            <option value="1">Region Controls</option>
            <option value="2">Mic Controls</option>
            <option value="3">Equalizer</option>
            <option value="4">Download</option>
        </select>
    </center>

    <!--Region Controls-->
    <center>
        <div style="display: none;" id='regioncontrols'><br/>
            <h1>Region Controls:</h1>
            <input class = "button" type="button" id="btn-addregions" value="Add Regions"/>
            <input class = "button" type="button" id="btn-clearregions" value="Clear Regions"/>
            <br>
            <br>
        </div> 

        <!--Mic Controls-->
        <div style='display:none;' id='miccontrols'><br/>
            <h1>Mic Controls:</h1>
            <input class = "button" type="button" id="btn-micon" value="MicOn" disabled="disabled"/>
            <input class = "button" type="button" id="btn-micoff" value="MicOff" disabled="disabled"/>
            <div class="wrapper">

                <div class="audio-wrapper">
                    <audio src="" controls class="js-audio audio"></audio>
                </div>

                <div class="toolbar">
                    <button class="js-start button button--start">Record</button>
                    <button class="js-stop button button--stop">Stop Recording</button>
                </div>
            </div>
        </div>

        <!--Equalizer Controls-->
        <div class = equal style='display:none;' id='equalizercontrols'><br/>

            <h1>Equalizer Controls:</h1>
            <input orient="vertical" id=range1 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range2 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range3 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range4 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range5 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range6 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range7 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range8 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range9 type="range" min="-25" max="25" value="0">
            <input orient="vertical" id=range10 type="range" min="-25" max="25" value="0">    

        </div>

        <!--Download Controls-->
        <div style='display:none;' id='downloadfile'><br/>
            <h1>Download File:</h1>
            <p>Name the file that will be downloaded (.mp3 is already included):</p>
            <form id="form" onsubmit="return false;">
                <input class= "textborder" type="text" id="userInput" /> <br>
                <input class = "button" type="button" value = "Submit File Name" onclick="othername();" />
                <p id="filename"></p>
            </form>
            <br>

            <a id= "download_song" >
                <input class = "button" type="button" id="btn-download" value="Download File" disabled="disabled"/>
            </a>
        </div>

        <br>
        <br>
        <!--Reddit Picture-->
        <div class = "redditabsolute">
            <a href="https://www.reddit.com/r/musicai/">
                <img alt="reddit" src="reddit.png"
                     width="70" height="70">
            </a>
        </div>      

        <!--MusicAi Picture-->
        <div class = "musicaiabsolute">
            <a href="https://projectmusicai.wordpress.com/">
                <img alt="musicai" src="musicai.png"
                     width="90" height="90">
            </a>
        </div>
        
        <div class = "twitterabsolute">
            
                <img alt="Twitter" src="Twitter.png"
                     width="90" height="70"
                     onclick = twitter_textbox();>
           
        </div>
        
        <div class = "youtubeabsolute">
                <img alt="Youtube" src="Youtube.png"
                     width="80" height="80"
                     onclick=youtube_upload();>
            
        </div>
        
        <b>Customize your tweet:</b>
        <form>
            <input type="text" name="Fname" value="Look at what I created with MusicAi!" id="tweet" size = 50>
        </form>


        <!--END OF HTML PORTION-->

        <script>
            // Internal Javascript Code

            // Creating variables for the wave surfer plugins
            var RegionsPlugin = window.WaveSurfer.regions;
            var CursorPlugin = window.WaveSurfer.cursor;
            var TimelinePlugin = window.WaveSurfer.timeline;
            var MicrophonePlugin = window.WaveSurfer.microphone;

            // Naming the buttons used in the program so that I don't need to use getElement everytime
            var buttons = {
                play: document.getElementById("btn-play"),
                pause: document.getElementById("btn-pause"),
                stop: document.getElementById("btn-stop"),
                addregions: document.getElementById("btn-addregions"),
                clearregions: document.getElementById("btn-clearregions"),
                mute: document.getElementById("btn-mute"),
                unmute: document.getElementById("btn-unmute"),
                download: document.getElementById("btn-download"),
                micon: document.getElementById("btn-micon"),
                micoff: document.getElementById("btn-micoff"),
            };

            // Naming the sliders for the equalizer so that I don't need to use getElement everytime
            var sliders = {
                slider1: document.getElementById("range1"),
                slider2: document.getElementById("range2"),
                slider3: document.getElementById("range3"),
                slider4: document.getElementById("range4"),
                slider5: document.getElementById("range5"),
                slider6: document.getElementById("range6"),
                slider7: document.getElementById("range7"),
                slider8: document.getElementById("range8"),
                slider9: document.getElementById("range9"),
                slider10: document.getElementById("range10")
            };

            // Creates the wave surfer visualizer object
            var Spectrum = WaveSurfer.create({
                container: '#audio-spectrum',
                splitChannels: true, // Allows a cool overlay effect and if I want multiple channels in the future it is there
                splitChannelsOptions: {
                    overlay: true,
                    channelColors: {
                        0: {
                            progressColor: 'blue',
                            waveColor: 'gray'
                        },
                        1: {
                            progressColor: 'gray',
                            waveColor: 'black'
                        }
                    }
                },

                plugins: [// Regions, Cursor, and Timeline
                    new WaveSurfer.regions.create({}),

                    new WaveSurfer.cursor.create({
                        showTime: true,
                        position: 'relative',
                        opacity: 1,
                        customShowTimeStyle: {
                            'background-color': '#000',
                            color: '#fff',
                            padding: '2px',
                            'font-size': '10px'
                        }
                    }),

                    new TimelinePlugin.create({
                        container: "#wave-timeline"
                    }),
                ]
            });

            // Creates Microphone object in Wavesurfer, Primarily used to show user when mic is on and allow them to toggle it
            var wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'black',
                interact: false,
                cursorWidth: 1,
                bufferSize: 16384,

                fillParent: true,
                minPxPerSec: 1000,
                plugins: [
                    WaveSurfer.microphone.create()
                ]
            });

            // Plays the music
            buttons.play.addEventListener("click", function () {
                Spectrum.play();
            }, false);

            //Pauses the music
            buttons.pause.addEventListener("click", function () {
                Spectrum.pause();
            }, false);

            // Stops and brings music back to beginning
            buttons.stop.addEventListener("click", function () {
                Spectrum.stop();
            }, false);

            // Adjusts the wavesurfer object if the window is resized
            window.addEventListener("resize", function () {
                var currentProgress = Spectrum.getCurrentTime() / Spectrum.getDuration();

                Spectrum.empty();
                Spectrum.drawBuffer();
                Spectrum.seekTo(currentProgress);

            }, false);

            // Get Download name
            function othername() {

                var input = document.getElementById("userInput").value;
                document.getElementById("filename").innerHTML =
                        "Current File Name: " + input;
                buttons.download.disabled = false;
                const urlParams = new URLSearchParams(window.location.search);
                var fn = urlParams.getAll('fn');
                const fn_prefix = 'results/';
                fn = fn_prefix + fn[0];
                console.log(fn);
                var ds = document.getElementById("download_song");
                ds.setAttribute('download', input + ".mp3");
                ds.href = fn;
                
            }

            // Dropdown Controls
            $(document).ready(function () {
                $("#regioncontrols").hide();
                $("#miccontrols").hide();
                $("#equalizercontrols").hide();
                $("#downloadfile").hide();
                $('#dropdown').on('change', function () {
                    if (this.value == '0')
                    {
                        $("#regioncontrols").hide();
                        $("#miccontrols").hide();
                        $("#equalizercontrols").hide();
                        $("#downloadfile").hide();
                    }

                    if (this.value == '1')
                    {
                        $("#regioncontrols").show();
                        $("#miccontrols").hide();
                        $("#equalizercontrols").hide();
                        $("#downloadfile").hide();
                    }

                    if (this.value == '2')
                    {
                        $("#regioncontrols").hide();
                        $("#miccontrols").show();
                        $("#equalizercontrols").hide();
                        $("#downloadfile").hide();
                    }

                    if (this.value == '3')
                    {
                        $("#regioncontrols").hide();
                        $("#miccontrols").hide();
                        $("#equalizercontrols").show();
                        $("#downloadfile").hide();
                    }

                    if (this.value == '4')
                    {
                        $("#regioncontrols").hide();
                        $("#miccontrols").hide();
                        $("#equalizercontrols").hide();
                        $("#downloadfile").show();

                    }

                });
            });
            buttons.micon.disabled = false;
            // When the mp3 file is loaded
            Spectrum.on('ready', function () {
                buttons.mute.disabled = false;


                // EQUALIZER:

                //Establish Frequencies, types, and id to attach to equalizer
                var EQ = [
                    {
                        f: 32,
                        type: 'lowshelf',
                        id: 1
                    },
                    {
                        f: 64,
                        type: 'peaking',
                        id: 2
                    },
                    {
                        f: 125,
                        type: 'peaking',
                        id: 3
                    },
                    {
                        f: 250,
                        type: 'peaking',
                        id: 4
                    },
                    {
                        f: 500,
                        type: 'peaking',
                        id: 5
                    },
                    {
                        f: 1000,
                        type: 'peaking',
                        id: 6
                    },
                    {
                        f: 2000,
                        type: 'peaking',
                        id: 7
                    },
                    {
                        f: 4000,
                        type: 'peaking',
                        id: 8
                    },
                    {
                        f: 8000,
                        type: 'peaking',
                        id: 9
                    },
                    {
                        f: 16000,
                        type: 'highshelf',
                        id: 10
                    }
                ];

                // Create the filters with the above specifications
                var filters = EQ.map(function (band) {
                    var filter = Spectrum.backend.ac.createBiquadFilter();
                    filter.type = band.type;
                    filter.gain.value = 0;
                    filter.Q.value = 1;
                    filter.frequency.value = band.f;
                    filter.id = band.id
                    return filter;
                });

                // Connect filters to wavesurfer
                Spectrum.backend.setFilters(filters);

                Spectrum.setVolume(0.7);
                document.querySelector('#volume').value = Spectrum.backend.getVolume();

                // Attaches the filters to the range sliders for each one
                filters.forEach(function (filter) {
                    if (filter.id = '1')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };
                        sliders.slider1.addEventListener('input', onChange);
                        sliders.slider1.addEventListener('change', onChange);
                    }

                    if (filter.id = '2')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider2.addEventListener('input', onChange);
                        sliders.slider2.addEventListener('change', onChange);
                    }

                    if (filter.id = '3')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider3.addEventListener('input', onChange);
                        sliders.slider3.addEventListener('change', onChange);
                    }

                    if (filter.id = '4')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider4.addEventListener('input', onChange);
                        sliders.slider4.addEventListener('change', onChange);
                    }

                    if (filter.id = '5')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider5.addEventListener('input', onChange);
                        sliders.slider5.addEventListener('change', onChange);
                    }

                    if (filter.id = '6')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider6.addEventListener('input', onChange);
                        sliders.slider6.addEventListener('change', onChange);
                    }

                    if (filter.id = '7')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider7.addEventListener('input', onChange);
                        sliders.slider7.addEventListener('change', onChange);
                    }

                    if (filter.id = '8')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider8.addEventListener('input', onChange);
                        sliders.slider8.addEventListener('change', onChange);
                    }

                    if (filter.id = '9')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider9.addEventListener('input', onChange);
                        sliders.slider9.addEventListener('change', onChange);
                    }

                    if (filter.id = '10')
                    {
                        var onChange = function (a) {
                            filter.gain.value = ~~a.target.value;
                        };

                        sliders.slider10.addEventListener('input', onChange);
                        sliders.slider10.addEventListener('change', onChange);
                    }
                });

                Spectrum.filters = filters;

            });

            //REGION CODE
            Spectrum.on('ready', function () {
                Spectrum.enableDragSelection({});
            });

            Spectrum.on('region-click', function (region, e) {
                console.log(region.start);
                console.log(region.end);
                e.stopPropagation();
                Spectrum.play(region.start, region.end);

            });
            // Gives the user a region on program launch
            Spectrum.addRegion({
                start: 0, // time in seconds
                end: 3, // time in seconds
                color: 'hsla(200, 100%, 30%, 0.1)'
            });

            // Button to add more regions if user doesn't want to do the drag regions
            buttons.addregions.addEventListener("click", function () {
                Spectrum.addRegion({
                    start: 4, // time in seconds
                    end: 7, // time in seconds
                    color: 'hsla(200, 100%, 30%, 0.1)'
                });
            });

            // Clear Regions
            buttons.clearregions.addEventListener("click", function () {
                Spectrum.clearRegions();
            });

            Spectrum.on('region-dblclick', function (region, e) {
                region.remove();
            });

            // mute and unmute
            buttons.mute.addEventListener("click", function () {
                Spectrum.toggleMute();
                buttons.mute.disabled = true;
                buttons.unmute.disabled = false;
            });

            buttons.unmute.addEventListener("click", function () {
                Spectrum.toggleMute();
                buttons.unmute.disabled = true;
                buttons.mute.disabled = false;
            });

            //Volume Controls
            var volumeInput = document.querySelector('#volume');

            var onChangeVolume = function (e) {
                Spectrum.setVolume(e.target.value);
                console.log(e.target.value);
            };

            volumeInput.addEventListener('input', onChangeVolume);
            volumeInput.addEventListener('change', onChangeVolume);

            //Mic Controls
            wavesurfer.microphone.on('deviceReady', function (stream) {
                console.log('Device ready!', stream);
            });

            wavesurfer.microphone.on('deviceError', function (code) {
                console.warn('Device error: ' + code);
            });

            // start the microphone
            buttons.micon.addEventListener("click", function () {
                wavesurfer.microphone.start();
                wavesurfer.microphone.play();
                buttons.micon.disabled = true;
                buttons.micoff.disabled = false;

                // Sets the stream element to a recording variable
                navigator.mediaDevices.getUserMedia({
                    audio: true
                })
                        .then(stream => {
                            recorder = new MediaRecorder(stream);

                            // If user wants to add more to recording they can press record again
                            recorder.ondataavailable = saveChunkToRecording;
                            recorder.onstop = saveRecording;
                        });
            });

            // stop the microphone
            buttons.micoff.addEventListener("click", function () {

                wavesurfer.microphone.stopDevice();

                buttons.micon.disabled = false;
                buttons.micoff.disabled = true;
            });

            // RECORDING
            const chunks = [];

            let recorder = null;
            let audioElement = null;
            let startButton = null;
            let stopButton = null;

            const saveChunkToRecording = (event) => {
                chunks.push(event.data);
            };

            // Saves the recoding to an mp3 
            const saveRecording = () => {
                const blob = new Blob(chunks, {
                    type: 'audio/mp3; codecs=opus'
                });

                const url = URL.createObjectURL(blob);

                audioElement.setAttribute('src', url);
            };

            // Record Start Function
            const startRecording = () => {
                recorder.start();
            };

            // Record Stop Function
            const stopRecording = () => {
                recorder.stop();
            };

            // Wait until everything has loaded
            (function () {
                audioElement = document.querySelector('.js-audio');
                startButton = document.querySelector('.js-start');
                stopButton = document.querySelector('.js-stop');

                // Button controls
                startButton.addEventListener('mouseup', startRecording);
                stopButton.addEventListener('mouseup', stopRecording);
            })();

            // Get File Name
            const urlParams = new URLSearchParams(window.location.search);
            var fn = urlParams.getAll('fn');
            const fn_prefix = 'results/';
            fn = fn_prefix + fn[0];

            //loads the song from musicai into the musicplayer
            Spectrum.load(fn);


            // End of JS Portion
        </script>

    </body>
    
</html>
